# kaku (My English Journal) — Phase 1 MVP要件定義書

## 1. プロダクト概要

### 1.1 プロダクト名

### アプリ名：kaku (My English Journal)

### 1.2 コンセプト

日々の出来事や考えを英語で日記として記録する。AIが自然な英語ナラティブを生成し、学習要素（キーフレーズ・言い換え・復習テスト）も自動付与。書くことで英語力を磨き、記録として残す。

### 1.3 ターゲットユーザー

- TOEIC 600〜900点程度
- 読める・聞けるが、会議等で言語化できない
- 汎用フレーズ学習に飽きている

---

## 2. MVPのスコープ（Phase 1）

### 2.1 MVPで提供する価値

- 日本語入力から、英語スクリプトと学習要素を一括生成
- 最小の復習運用（Notion / Sheets）に接続できるデータ形式（および内蔵管理機能）
- 音声再生（端末内蔵TTS）で音読・シャドーイングを始められる
- **[追加] ユーザー認証とデータ永続化（Supabaseによる個人データ管理）**

### 2.2 Phase 1でやらないこと

- 音声認識、発音採点、課金、アプリストア配布
- 履歴を使ったパーソナライズ最適化（モデル学習的なもの）
- 高度なSRS自動リマインド（OSプッシュ通知など。アプリ内での管理は可）

---

## 3. 機能要件

## 3.1 Narrative Generator

### 3.1.1 ユーザーフロー

1. **[ログイン/新規登録]**
2. **[1日1回制限チェック]** (既に今日作成済みの場合は、ダッシュボードへ誘導)
3. カテゴリ選択
4. 深掘り質問（2〜3問）
5. 出力設定確認（長さ・トーン）
6. 生成（JSONで受け取り、UI表示および自動保存）
7. TTS再生、コピー、保存（外部エクスポート）

### 3.1.2 カテゴリ

- 今日の出来事
- 考え・気持ち
- おまかせ

### 3.1.3 深掘り質問

- 日本語で2〜3問
- 回答は自由入力テキスト
- 追加の1行入力（任意）を用意する
  例：目的、相手、数字、結論、のうち足りないものを1行で補う

### 3.1.4 出力設定

- 長さ：短め（3〜4文）／普通（5〜8文）／長め（10文以上）
- トーン：カジュアル／ビジネス／フォーマル
- Phase 1のデフォルトは「普通・ビジネス」

---

## 3.2 生成アウトプット仕様（固定JSON）

### 3.2.1 JSONスキーマ（必須）

- narrative_en: string
  英文。文数は設定に従う。改行は許容。
- key_phrases: array（最大5件）
  - phrase_en: string
  - meaning_ja: string
  - usage_hint_ja: string（短文）

- alternatives: array（最大2件）
  - original_en: string（本文からの該当表現）
  - alternative_en: string（言い換え）
  - nuance_ja: string（違いの説明を短く）

- recall_test: object（必須）
  - prompt_ja: string（要点3点程度の日本語）
  - expected_points_en: array（2〜4点、箇条書き想定。逐語回答ではなく要点）

- pronunciation: object（任意、該当時のみ）
  - word: string
  - ipa: string
  - tip_ja: string（アクセント等）

### 3.2.2 出力制約

- 普通：narrative_en は5〜8文を基本（±1文までは許容）
- key_phrases は最大5、alternatives は最大2、recall_test は必ず1問
- 日本語混入は最小化（英語本文に日本語を混ぜない）

---

## 3.3 品質・失敗判定（自動）

### 3.3.1 自動失敗判定条件（いずれかで失敗）

- JSONとしてパース不能
- 必須キー欠落（narrative_en / key_phrases / alternatives / recall_test）
- narrative_en が設定文数から大きく外れる（例：普通で3文以下、10文以上）
- 英語本文に日本語が多量に混入
- key_phrases が0件、alternatives が0件（いずれも最低1件は必要）

### 3.3.2 失敗時の挙動

- フォールバック1：DeepSeek（同一入力で再生成）
- それでも失敗：フォールバック2：xAI Grok
- それでも失敗：エラー表示（手動再試行ボタン、入力保持）

---

## 3.4 モデル・ルーティング要件

### 3.4.1 通常ルート

- Gemini 2.0 Flash で生成

### 3.4.2 フォールバック順

- DeepSeek-V3 / R1 → Grok-Beta

---

## 3.5 TTS（ブラウザ内蔵）

### 3.5.1 使用技術

- Web Speech API（speechSynthesis）

### 3.5.2 UI要件

- Voice選択（en-US / en-GB など端末内ボイス一覧から選択）
- 再生速度プリセット（例：0.9 / 1.0 / 1.1）
- **文単位のインタラクティブ再生**（文章内の各文をクリックすることで、その文のみを再生・ハイライト表示）
- クリップボードコピー

---

## 3.6 デジタルSRS（Phase 1実装済み）

### 3.6.1 管理

- Supabase によるデータ永続化

### 3.6.2 復習間隔（可変・SRSアルゴリズム）

- ユーザーの自己評価に基づき次回復習日を算出
- スケジュール管理：Dashboardにて「今日の復習」を表示

---

## 3.7 UI/UX デザイン要件

### 3.7.1 モバイル最適化 (Mobile-First)

- **ボトムナビゲーション**: モバイル端末では画面下部に「書く」「振り返り」「カレンダー」「データ」の4つのタブを固定表示。
- **コンパクトヘッダー**: ユーザープロファイル情報をアイコン化し、ポップオーバー形式で管理（ログアウト等）。画面占有率を最小化。
- **カードレイアウト**: モバイル画面幅を最大限活用し、余計なヘッダーやナビゲーションリンクを排除したシンプルな構成。
- **スクロール配慮**: 固定ナビゲーションがコンテンツと重ならないよう、十分な下部パディングを確保。

---

## 4. 非機能要件

## 4.1 コスト前提（目安）

- 1回の生成で入力1500 tokens、出力600 tokens程度を上限の目安に設計
- 呼び出し回数を増やさない（原則1回、失敗時のみ再生成）

## 4.2 セキュリティ・プライバシー

- **ユーザー認証**: Supabase Auth による個人データ分離
- **データ保護**: RLS (Row Level Security) により、他者のナラティブの閲覧・編集を禁止

## 4.3 可用性

- 1社の障害で止まらないよう、フォールバックを実装済み
